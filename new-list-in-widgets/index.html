<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Displayer Client</title>
    <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/rainbow.css" rel="stylesheet">

    <!-- syntax highlighting -->
    <script src="../lib/rainbow.js"></script>
    <script src="../lib/rainbow-lang/coffeescript.js"></script>
    <script src="../lib/rainbow-lang/css.js"></script>
    <script src="../lib/rainbow-lang/generic.js"></script>
    <script src="../lib/rainbow-lang/html.js"></script>
    <script src="../lib/rainbow-lang/javascript.js"></script>

    <!-- dependencies -->
    <script src="http://cdn.intermine.org/js/jquery/1.7/jquery.min.js"></script>
    <script src="http://cdn.intermine.org/js/underscore.js/1.3.3/underscore-min.js"></script>
    <script src="http://cdn.intermine.org/js/backbone.js/0.9.2/backbone-min.js"></script>

    <!-- intermine -->
    <script src="http://cdn.intermine.org/api"></script>
    <script src="http://cdn.intermine.org/js/intermine/imjs/latest/imjs.js"></script>
    <script src="http://cdn.intermine.org/js/intermine/widgets/latest/intermine.widgets.js"></script>

    <script>
    (function() {
        var root = 'http://www.flymine.org/query'; // mine
        var tokn = 'U1p3r9Jb95r2Efrbu1P1CdfvKeF'; // API token
        var name = 'temp-list-from-js-query'; // temporary list name

        // Service connection.
        var flymine = new intermine.Service({
            'root':  root,
            'token': tokn
        });

        // The query herself.
        var query = {
            'select': [ 'symbol', 'primaryIdentifier' ],
            'from': 'Gene',
            'where': {
                'symbol': {
                    'contains': 'ze'
                }
            },
            'limit': 10
        };

        // Query on a mine.
        flymine.query(query, function(q) {
            // Have we encountered an error?
            var error = false;
            // Saving function.
            var save;
            (save = function() {
                // Save the query as a list.
                q.saveAsList({'name': name}, function(l) {
                    // Only run enrichments on non-empty lists.
                    if (l.size > 0) {
                        var widgets = new intermine.widgets(root + '/service/', tokn);
                        widgets.chart('flyfish', name, '#widget');
                    }
                }).error(function(e) {
                    if (e.status == 500 && !error) {
                        // First error case, hoping for an existing list.
                        error = true;
                        // HTTP DELETE.
                        $.ajax({
                            'url':         root + '/service/lists/json?name=' + name + '&token=' + tokn,
                            'type':        'DELETE'
                        }).done(function(done) {
                            // If we were succesfull, run the save again.
                            if (done.statusCode == 200) {
                                save();
                            }
                        });
                    }
                });
            })();
        });
    }).call(this);
    </script>
</head>

<body>
    <div class="container">
        <div class="row">
            <h1>Create a new list to use in a Widget</h1>
            <p>The process consists of first using the <strong>IMJS</strong> library to create a list and then using the <strong>List Widgets</strong> library to display the widget as usual</p>

            <div class="left">
            <h2>Requirements</h2>
            <ol>
                <li><strong>InterMine Generic WebService Client Library</strong> from <a href="https://github.com/alexkalderimis/imjs" target="_blank">GitHub</a> or <a href="http://cdn.intermine.org/js/intermine/imjs/latest/imjs.js" target="_blank">InterMine CDN</a>.</li>
                <li><strong>InterMine List Widgets Client Library</strong> from <a href="https://github.com/radekstepan/intermine-widget-client" target="_blank">GitHub</a> or <a href="http://cdn.intermine.org/js/intermine/widgets/latest/intermine.widgets.js" target="_blank">InterMine CDN</a>.</li>
                <li>A mine that has the desired Enrichment Widget <a href="http://intermine.org/wiki/Widgets" target="_blank">configured</a>.</li>
                <li>An <strong>API Access Key</strong> generated by logging in to MyMine and visiting the API Key tab, then clicking on Generate a new API key. This assumes that you do not want to automatically provide the API key as is the case of within mine embedding that can be seen for example <a href="https://github.com/intermine/intermine/blob/55ef91b7e7bbc0d8674697b005fc298647a1aa5a/intermine/webapp/main/resources/webapp/bagDetails.jsp#L327" target="_blank">here</a>.</li>
            </ol>

            <h2>Code</h2>

            <p>First require the JavaScript libraries needed to run the example. You probably have your own version of a <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a> compatible CSS style included on the page already.</p>

            <pre><code data-language="html"><!-- dependencies -->
&lt;script src=&quot;http://cdn.intermine.org/js/jquery/1.7/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;http://cdn.intermine.org/js/underscore.js/1.3.3/underscore-min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;http://cdn.intermine.org/js/backbone.js/0.9.2/backbone-min.js&quot;&gt;&lt;/script&gt;

&lt;!-- intermine --&gt;
&lt;script src=&quot;http://cdn.intermine.org/api&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;http://cdn.intermine.org/js/intermine/imjs/latest/imjs.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;http://cdn.intermine.org/js/intermine/widgets/latest/intermine.widgets.js&quot;&gt;&lt;/script&gt;</code></pre>

            <p>The next step is defining a couple of variables.</p>

            <pre><code data-language="javascript">var root = 'http://www.flymine.org/query';
var tokn = 'U1p3r9Jb95r2Efrbu1P1CdfvKeF'; // API token
var name = 'temp-list-from-js-query'; // temporary list name</code></pre>

            <p>Now we connect with the mine through IMJS.</p>

            <pre><code data-language="javascript">// Service connection.
var flymine = new intermine.Service({
    'root':  root,
    'token': tokn
});</code></pre>

            <p>Then we define the query whose results will be converted into a list later on.</p>

            <pre><code data-language="javascript">// The query herself.
var query = {
    'select': [ 'symbol', 'primaryIdentifier' ],
    'from': 'Gene',
    'where': {
        'symbol': {
            'contains': 'ze'
        }
    },
    'limit': 10
};</code></pre>

            <p>Now we call the mine converting the results of the query into a list.</p>

            <pre><code data-language="javascript">flymine.query(query, function(q) {
    // Save the query as a list.
    q.saveAsList({'name': name}, function(l) {
        // Now we have created a list under a name.
    });
});</code></pre>

            <p>Now, in the callback that has created the list, we can instantiate the List Widgets client and display the result.</p>

            <pre><code data-language="javascript">var widgets = new intermine.widgets(root + '/service/', tokn);
// A new Chart List Widget for a particular list in the target #widget.
widgets.chart('flyfish', name, '#widget');</code></pre>

            <p>The only problem with this approach is that if we make this sort of call multiple times, we will fail on the second and subsequent ocassions as we will get a WebService exception telling us that the 'temporary' list name is taken. <strong>Thus inspect the code of this page to see how to make a call to the service to delete the list if it exists.</strong></p>

            </div>

            <div class="right bootstrap">
                <div id="widget"></div>
            </div>
        </div>
    </div>
    <script>Rainbow.color();</script>
</body>
</html>